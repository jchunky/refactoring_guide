#!/bin/zsh
# Lint runner script for refactoring_guide project
# This script runs rubocop on all Ruby files for the specified version.
#
# Usage:
#   bin/lint <version>           # lint only
#   bin/lint -a <version>        # safe autocorrect
#   bin/lint -A <version>        # all autocorrect (including unsafe)
#
# Examples:
#   bin/lint v0
#   bin/lint -a v1
#   bin/lint -A v3

source ~/.zshrc

# Parse optional flag
AUTOCORRECT=""
if [ "$1" = "-a" ]; then
  AUTOCORRECT="--autocorrect"
  shift
elif [ "$1" = "-A" ]; then
  AUTOCORRECT="--autocorrect-all"
  shift
fi

if [ -z "$1" ]; then
  echo "Usage: bin/lint [-a | -A] <version>"
  echo ""
  echo "Options:"
  echo "  -a    Safe autocorrect"
  echo "  -A    All autocorrect (including unsafe)"
  echo ""
  echo "Examples:"
  echo "  bin/lint v0"
  echo "  bin/lint -a v1"
  echo "  bin/lint -A v3"
  echo ""
  echo "Available versions:"
  ls -d lib/*/ | xargs -n1 basename | sed 's/^/  /'
  exit 1
fi

VERSION=$1
export VERSION

echo "=== Refactoring Guide Lint Runner ==="
echo "Linting version: $VERSION"
if [ -n "$AUTOCORRECT" ]; then
  echo "Autocorrect: $AUTOCORRECT"
fi
echo ""

# Check if version directory exists
if [ ! -d "lib/${VERSION}" ]; then
  echo "Error: No implementation directory found for version '$VERSION'"
  echo ""
  echo "Available versions:"
  ls -d lib/*/ | xargs -n1 basename | sed 's/^/  /'
  exit 1
fi

# Collect all Ruby files in the version directory
ruby_files=(lib/${VERSION}/*.rb)

if [ ${#ruby_files[@]} -eq 0 ]; then
  echo "No Ruby files found in lib/${VERSION}/"
  exit 1
fi

echo "Running rubocop on ${#ruby_files[@]} file(s) in lib/${VERSION}/..."
echo ""

bundle exec rubocop $AUTOCORRECT "${ruby_files[@]}"

exit_code=$?

echo ""
echo "=== Lint run complete (version: $VERSION) ==="
exit $exit_code
